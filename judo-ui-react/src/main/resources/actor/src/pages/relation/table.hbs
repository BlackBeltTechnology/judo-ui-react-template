{{> fragment.header.hbs }}
// Page name: {{ page.name }}
// Page owner name: {{ page.owner.name }}
// Page DataElement name: {{ page.dataElement.name }}
// Page DataElement owner name: {{ page.dataElement.owner.name }}

import { useEffect, useState } from 'react';
import { useParams } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { Paper, Card, CardContent, Box, Grid, Button, Container } from '@mui/material';
import type { GridRowModel, GridRowParams, GridSortModel, GridValueFormatterParams } from '@mui/x-data-grid';
import { DataGrid, GridToolbarContainer } from '@mui/x-data-grid';
import { OBJECTCLASS } from '@pandino/pandino-api';
import type { JudoIdentifiable } from '@judo/data-api-common';
import type { Filter } from '{{ relativePathFromPage page 'components-api' }}';
import {
  MdiIcon,
  PageHeader,
  CustomBreadcrumb,
  CustomTablePagination,
} from '{{ relativePathFromPage page 'components' }}';
import { columnsActionCalculator } from '{{ relativePathFromPage page 'components/table' }}';
import { useFilterDialog } from '{{ relativePathFromPage page 'components/dialog' }}';
import { useErrorHandler, ERROR_PROCESSOR_HOOK_INTERFACE_KEY, mapAllFiltersToQueryCustomizerProperties, processQueryCustomizer } from '{{ relativePathFromPage page 'utilities' }}';
import type { PersistedTableData } from '{{ relativePathFromPage page 'utilities' }}';
import { pageServerTableConfig, toastConfig } from '{{ relativePathFromPage page 'config' }}';
import { useL10N } from '{{ relativePathFromPage page 'l10n' }}/l10n-context';
import { {{ pageName page }}PageActions } from './components/{{ pageName page }}PageActions';
import { use{{ pageName page }} } from './hooks/use{{ pageName page }}';
import {
  {{# each (getApiImportsForTablePage page) as |imp| }}
    {{ imp }},
  {{/ each }}
} from '{{ relativePathFromPage page 'generated/data-api' }}';
import {
  {{ dataElementRelationName page.dataElement }}Impl,
} from '{{ relativePathFromPage page 'generated/data-axios'}}';
import { mainContainerPadding } from '{{ relativePathFromPage page 'theme' }}';
import {
    {{# each (getUniquePageActions page) as |action| }}
        {{ actionFunctionHookName action page }},
    {{/ each }}
} from './actions';

/**
 * Name: {{ page.name }}
 * Is Access: false
 * Type: Table
 **/
export default function {{ pageName page }}() {
    const persistedTableData: PersistedTableData = JSON.parse(
        window.sessionStorage.getItem('pages.{{ pageName page }}') || '{}',
    );
    const { t } = useTranslation();
    const { signedIdentifier } = useParams();
    const { openFilterDialog } = useFilterDialog();
    const { locale: l10nLocale } = useL10N();
    const { columns, filterOptions, rowActions } = use{{ pageName page }}(fetchData, signedIdentifier);
    {{# each (getUniquePageActions page) as |action| }}
        {{# unless action.isFilterAction }}
            const {{ actionFunctionName action page }} = {{ actionFunctionHookName action page }}();
        {{/ unless }}
    {{/ each }}

    const handleFetchError = useErrorHandler(`(&(${OBJECTCLASS}=${ERROR_PROCESSOR_HOOK_INTERFACE_KEY})(operation=Fetch))`);
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [rowCount, setRowCount] = useState<number>(0);
    const [sortModel, setSortModel] = useState<GridSortModel>(
        persistedTableData.sortModel || {{{ getDefaultSortParamsForTable (getTableForTablePage page) }}},
    );
    const [lastItem, setLastItem] = useState<{{ classDataName page.dataElement.target 'Stored' }}>();
    const [firstItem, setFirstItem] = useState<{{ classDataName page.dataElement.target 'Stored' }}>();
    const [isNextButtonEnabled, setIsNextButtonEnabled] = useState<boolean>(true);
    const [page, setPage] = useState<number>(0);
    const [data, setData] = useState<GridRowModel<{{ classDataName page.dataElement.target 'Stored' }}>[]>([]);
    const [filters, setFilters] = useState<Filter[]>(persistedTableData.filters || []);
    const [queryCustomizer, setQueryCustomizer] = useState<{{ classDataName page.dataElement.target 'QueryCustomizer' }}>({
        {{# with (getTableForTablePage page) as |table| }}
        _mask: '{{ table.formattedMask }}',
        {{/ with }}
        _seek: {
            limit: {{ calculateTablePageLimit tablePageLimit }} + 1,
        },
        _orderBy: [
            {
                attribute: sortModel[0].field,
                descending: sortModel[0].sort === 'desc',
            },
        ],
        ...mapAllFiltersToQueryCustomizerProperties(
            filters,
            {{# with (getTableForTablePage page) as |table| }}
                {{# each table.filters as |filter| }}
                    '{{ filter.attributeType.name }}',
                {{/ each }}
            {{/ with }}
        ),
    });
    const title: string = t('{{ idToTranslationKey page.fQName application }}', { defaultValue: '{{ page.label }}' });

    function handleSortModelChange (newModel: GridSortModel) {
        setPage(0);
        setSortModel(newModel);

        const { field, sort } = newModel[0];

        setQueryCustomizer((prevQueryCustomizer) => {
            return {
                ...prevQueryCustomizer,
                _orderBy: [{ attribute: field, descending: sort === 'desc' }],
            };
        });
    }

    async function handlePageChange (isNext: boolean) {
        setQueryCustomizer((prevQueryCustomizer) => {
            return {
                ...prevQueryCustomizer,
                _seek: {
                    limit: isNext ? {{ calculateTablePageLimit tablePageLimit }} + 1 : {{ calculateTablePageLimit tablePageLimit }},
                    reverse: !isNext,
                    lastItem: isNext ? lastItem : firstItem,
                },
            };
        });

        setIsNextButtonEnabled(!isNext);
    }

    async function fetchData() {
        setIsLoading(true);

        try {
            const res = await {{ dataElementRelationName page.dataElement }}Impl.list{{ ucFirst page.dataElement.name }}(
                { __signedIdentifier: signedIdentifier } as JudoIdentifiable<{{ classDataName page.dataElement.target '' }}>,
                processQueryCustomizer(queryCustomizer),
            );

            if (res.length > {{ calculateTablePageLimit tablePageLimit }}) {
                setIsNextButtonEnabled(true);
                res.pop();
            } else if (queryCustomizer._seek?.limit === {{ calculateTablePageLimit tablePageLimit }} + 1) {
                setIsNextButtonEnabled(false);
            }

            setData(res);
            setFirstItem(res[0]);
            setLastItem(res[res.length - 1]);
            setRowCount(res.length || 0);
        } catch (error) {
            handleFetchError(error);
        } finally {
            setIsLoading(false);
        }
    }

    useEffect(() => {
        fetchData();
    }, [queryCustomizer]);

    useEffect(() => {
        window.sessionStorage.setItem(
            'pages.{{ pageName page }}',
            JSON.stringify({
                sortModel,
                filters,
            }),
        );
    }, [sortModel, filters]);

    {{# each (getUniquePageActions page) as |action| }}
        {{# if action.isFilterAction }}
            const {{ actionFunctionName action page }} = {{ actionFunctionHookName action page }}(setFilters, setPage, setQueryCustomizer, openFilterDialog);
        {{/ if }}
    {{/ each }}

    {{# with (getTableForTablePage page) as |table| }}
        return (
            <>
                <PageHeader title={title}>
                    <{{ pageName page }}PageActions fetchData={fetchData} isLoading={isLoading} signedIdentifier={signedIdentifier} />
                </PageHeader>
                <Container component="main" maxWidth="xl">
                    <Box sx={mainContainerPadding}>
                        <Grid container spacing={2}>
                            <Grid item xs={12}>
                                <Card>
                                    <CardContent id="{{ createId page }}-data-grid">
                                        <DataGrid
                                            { ...pageServerTableConfig }
                                            sx={ {
                                                // overflow: 'hidden',
                                                display: 'grid',
                                            } }
                                            getRowId={(row: { __identifier: string }) => row.__identifier}
                                            loading={isLoading}
                                            rows={data}
                                            rowCount={rowCount}
                                            getRowClassName={() => "data-grid-row"}
                                            getCellClassName={() => "data-grid-cell"}
                                            sortModel={sortModel}
                                            onSortModelChange={handleSortModelChange}
                                            columns={[...columns, ...columnsActionCalculator('{{ createId table.dataElement }}', rowActions, { shownActions: 2 })]}
                                            {{# each (getUniquePageActions page) as |action| }}
                                                {{# if action.isViewAction }}
                                                    onRowClick={ (params: GridRowParams<{{ classDataName table.dataElement.target 'Stored' }}>) => {{ actionFunctionName action page }}({ __signedIdentifier: signedIdentifier } as JudoIdentifiable<{{ classDataName table.dataElement.owner '' }}>, params.row) }
                                                {{/ if }}
                                            {{/ each }}
                                            components={ {
                                                Toolbar: () => (
                                                    <GridToolbarContainer>
                                                        {{# each (getUniquePageActions page) as |action| }}
                                                            {{# if action.isFilterAction }}
                                                                <Button
                                                                    id="{{ createId action }}"
                                                                    variant="outlined"
                                                                    onClick={ async () => {{ actionFunctionName action page }}('{{ createId action }}-filter', filterOptions, filters) }
                                                                    disabled={isLoading}
                                                                >
                                                                    <MdiIcon path="filter" />
                                                                    {t('judo.pages.table.set-filters', { defaultValue: 'Set filters' }) + (filters.length !== 0 ? ' (' + filters.length + ')' : '')}
                                                                </Button>
                                                            {{/ if }}
                                                        {{/ each }}
                                                    </GridToolbarContainer>
                                                ),
                                                Pagination: () => (
                                                    <CustomTablePagination
                                                            pageChange={handlePageChange}
                                                            isNextButtonEnabled={isNextButtonEnabled}
                                                            page={page}
                                                            setPage={setPage}
                                                            rowPerPage={ {{ calculateTablePageLimit tablePageLimit }} }
                                                    />
                                                ),
                                            } }
                                        />
                                    </CardContent>
                                </Card>
                            </Grid>
                        </Grid>
                    </Box>
                </Container>
            </>
        );
    {{/ with }}
}
